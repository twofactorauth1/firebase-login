From abb8fcb6adf6392e35a1a3d32581336780597055 Mon Sep 17 00:00:00 2001
From: Ashish <ashu8006kumar@gmail.com>
Date: Mon, 3 Apr 2017 12:04:04 +0530
Subject: [PATCH] Images that have been renamed retain their original file name
 #6969. updated as per discussed

---
 api/1.0/assets.api.js                              |  3 ++-
 assets/asset_manager.js                            | 30 +++++++++++++++++++---
 .../assets/js/controllers/modals/mediaModalCtrl.js |  1 +
 3 files changed, 29 insertions(+), 5 deletions(-)

diff --git a/api/1.0/assets.api.js b/api/1.0/assets.api.js
index b55b06e..f295426 100644
--- a/api/1.0/assets.api.js
+++ b/api/1.0/assets.api.js
@@ -273,6 +273,7 @@ _.extend(api.prototype, baseApi.prototype, {

         var assetId = req.params.id;
         var accountId = parseInt(self.accountId(req));
+        var userId = self.userId(req);;
         assetManager.getAsset(assetId, function(err, savedAsset){
             if(err) {
                 return self.wrapError(res, 404, 'Asset not found', 'Could not find asset with id [' + assetId + '].');
@@ -283,7 +284,7 @@ _.extend(api.prototype, baseApi.prototype, {
                 } else {
                     var asset = new $$.m.Asset(req.body);
                     asset.set('_id', assetId);
-                    assetManager.updateAsset(asset, function(err, value) {
+                    assetManager.updateAsset(asset, userId, function(err, value) {
                         self.log.debug('<< updateAsset');
                         self.sendResultOrError(res, err, value, "Error updating Asset");
                         self.createUserActivity(req, 'UPDATE_ASSET', null, null, function(){});
diff --git a/assets/asset_manager.js b/assets/asset_manager.js
index e41962c..7b5f5bc 100644
--- a/assets/asset_manager.js
+++ b/assets/asset_manager.js
@@ -181,10 +181,33 @@ module.exports = {
         });
     },

-    updateAsset: function(asset, fn) {
+    updateAsset: function(asset, userId, fn) {
+        var self = this;
+        self.log = log;
+        self.log.debug('>> updateAsset');
+        var subdir = 'account_' + asset.get('accountId');
+        if(appConfig.nonProduction === true) {
+            subdir = 'test_' + subdir;
+        }
+       var oldUrl= asset.get("url")
+       var newDestUrl= oldUrl.substring( 0,
+            oldUrl.indexOf(subdir)+ subdir.length+1) + asset.get("filename");
+       self.copyS3Asset( asset.get('accountId'),userId,oldUrl,newDestUrl,
+            asset.get('mimeType'),
+            function(err, value){
+                if(err) {
+                    self.log.error('Exception in updateAsset:copyS3Asset ' + err);
+                    fn(err, null);
+                } else {
+                    self.log.debug('<< copyS3Asset',value);
+                    asset.set('url',newDestUrl);
+                    self.updateAssetObject(asset,userId ,fn);
+                }
+        });
+    },
+    updateAssetObject: function(asset, userId, fn) {
         var self = this;
         self.log = log;
-
         self.log.debug('>> updateAsset');
         assetDao.saveOrUpdate(asset, function(err, value){
             if(err) {
@@ -194,9 +217,8 @@ module.exports = {
                 self.log.debug('<< updateAsset');
                 fn(null, value);
             }
-        });
+        })
     },
-
     deleteAsset: function(assetId, fn) {
         //TODO: delete from the source as well
         var self = this;
diff --git a/public/admin/assets/js/controllers/modals/mediaModalCtrl.js b/public/admin/assets/js/controllers/modals/mediaModalCtrl.js
index 9d76040..7070d17 100755
--- a/public/admin/assets/js/controllers/modals/mediaModalCtrl.js
+++ b/public/admin/assets/js/controllers/modals/mediaModalCtrl.js
@@ -443,6 +443,7 @@ app.controller('MediaModalCtrl', ['$scope', '$injector', '$modalInstance', '$htt
     originalAsset.accountId = $scope.account._id;
     AssetsService.updateAsset(originalAsset, function (data, status) {
       if (status == 200) {
+        asset.url=data.url;
         ToasterService.show('success', 'Asset updated.');
       }
     });
--
2.4.9 (Apple Git-60)

